---
import '../styles/global.css';
import { db } from '../db';
import { products } from '../db/schema';
import { eq, desc, like, or, sql } from 'drizzle-orm';

// --- 1. KONFIGURASI PAGINATION & SEARCH ---
const limit = 6; 
const page = Number(Astro.url.searchParams.get('page') || '1');
const offset = (page - 1) * limit;
const searchQuery = Astro.url.searchParams.get('q') || '';

// --- 2. LOGIKA SERVER (CRUD ACTIONS) ---
if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const _action = formData.get("_action");
  const id = Number(formData.get("id"));

  const productData = {
    name: formData.get("name") as string,
    description: formData.get("description") as string,
    total: Number(formData.get("total") || 0),
    unitType: formData.get("unitType") as string,
    costPrice: Number(formData.get("costPrice") || 0),
    sellingPrice: Number(formData.get("sellingPrice") || 0),
  };

  try {
    if (_action === "create") {
      // PENTING: Jangan masukkan 'id' agar auto-increment Turso bekerja
      await db.insert(products).values({ 
        ...productData, 
        createdAt: new Date().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) 
      }).run();
    } else if (_action === "update") {
      await db.update(products).set(productData).where(eq(products.id, id)).run();
    } else if (_action === "delete") {
      await db.delete(products).where(eq(products.id, id)).run();
    }
  } catch (e) {
    console.error("Gagal mutasi data:", e);
  }
  
  return Astro.redirect(`/?page=${page}&q=${searchQuery}`);
}

// --- 3. QUERY DATA REAKTIF ---
let filteredAll = [];
try {
  // Cegah error params %% dengan filter kondisional
  if (!searchQuery.trim()) {
    filteredAll = await db.select().from(products).all();
  } else {
    filteredAll = await db.select().from(products)
      .where(
        or(
          like(products.name, `%${searchQuery}%`), 
          like(products.description, `%${searchQuery}%`)
        )
      )
      .all();
  }
} catch (e) {
  console.error("Gagal memuat data:", e);
}

// 4. Hitung Statistik (Berdasarkan hasil filter)
const statTotalProducts = filteredAll.length;
const statTotalUnits = filteredAll.reduce((acc, p) => acc + (p.total || 0), 0);
const statTotalValue = filteredAll.reduce((acc, p) => acc + ((p.costPrice || 0) * (p.total || 0)), 0);

// 5. Sorting & Pagination (Terbaru di paling atas)
const displayedProducts = [...filteredAll]
  .sort((a, b) => (b.id || 0) - (a.id || 0))
  .slice(offset, offset + limit);

const totalPages = Math.ceil(statTotalProducts / limit);
---

<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toko Nusantara Jaya - Dashboard</title>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

<div class="max-w-[1400px] mx-auto p-4 md:p-6 lg:p-8">
    <header class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
        <div>
            <h1 class="text-3xl font-black text-slate-900 tracking-tight">Toko Nusantara Jaya</h1>
            <p class="text-indigo-600 font-bold uppercase tracking-widest text-[12px]">Sistem Inventaris</p>
        </div>

        <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
            <div class="relative flex-1 md:w-80">
                <input type="text" id="realtimeSearch" placeholder="Cari barang..." value={searchQuery}
                    class="w-full pl-10 pr-4 py-2.5 rounded-xl border-none shadow-sm ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none bg-white text-sm" />
                <svg class="w-5 h-5 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            
            <button onclick="openEntryModal()" class="bg-indigo-600 text-white font-bold px-5 py-2.5 rounded-xl text-sm hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">
                + Barang
            </button>
        </div>
    </header>

    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
            <p class="text-slate-400 text-[9px] font-black uppercase tracking-widest mb-1">Hasil Pencarian</p>
            <p class="text-2xl font-black text-slate-800">{statTotalProducts} <span class="text-[10px] font-normal text-slate-400">Item</span></p>
        </div>
        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
            <p class="text-slate-400 text-[9px] font-black uppercase tracking-widest mb-1">Stok Tersedia</p>
            <p class="text-2xl font-black text-indigo-600">{statTotalUnits.toLocaleString('id-ID')}</p>
        </div>
        <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
            <p class="text-slate-400 text-[9px] font-black uppercase tracking-widest mb-1">Estimasi Nilai Aset</p>
            <p class="text-2xl font-black text-emerald-600">Rp {statTotalValue.toLocaleString('id-ID')}</p>
        </div>
    </div>

    <main class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead>
                    <tr class="bg-slate-50/50 border-b border-slate-100 text-slate-400 text-[10px] uppercase font-black tracking-widest">
                        <th class="px-6 py-4">Produk</th>
                        <th class="px-6 py-4 text-center">Stok</th>
                        <th class="px-6 py-4">Struktur Harga</th>
                        <th class="px-6 py-4 text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-50">
                    {displayedProducts.length > 0 ? displayedProducts.map((p) => (
                        <tr class="hover:bg-slate-50 transition-colors group">
                            <td class="px-6 py-3">
                                <div class="font-bold text-slate-800 leading-tight">{p.name}</div>
                                {p.description && <div class="text-[11px] text-slate-400 line-clamp-1 mt-0.5">{p.description}</div>}
                                <div class="text-[9px] text-slate-300 font-medium mt-1 uppercase tracking-tighter">SKU-{p.id} â€¢ {p.createdAt}</div>
                            </td>
                            <td class="px-6 py-3 text-center">
                                <div class="inline-block px-3 py-1 bg-slate-100 rounded-lg font-black text-slate-700">
                                    {p.total} <span class="text-[9px] text-slate-400 font-normal">{p.unitType}</span>
                                </div>
                            </td>
                            <td class="px-6 py-3 whitespace-nowrap">
                                <div class="flex flex-col">
                                    <span class="text-[11px] font-bold text-red-400">Modal: Rp {(p.costPrice ?? 0).toLocaleString('id-ID')}</span>
                                    <span class="text-[13px] font-black text-emerald-600">Jual: Rp {(p.sellingPrice ?? 0).toLocaleString('id-ID')}</span>
                                </div>
                            </td>
                            <td class="px-6 py-3">
                                <div class="flex justify-center gap-2">
                                    <button onclick={`openEditModal(${JSON.stringify(p)})`} class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                    </button>
                                    <form method="POST" onsubmit="return confirm('Hapus barang ini?')">
                                        <input type="hidden" name="_action" value="delete" />
                                        <input type="hidden" name="id" value={p.id} />
                                        <button type="submit" class="p-2 text-red-400 hover:bg-red-50 rounded-lg transition">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    )) : (
                        <tr>
                            <td colspan="4" class="px-6 py-12 text-center text-slate-400 italic">Data tidak ditemukan atau belum diinput...</td>
                        </tr>
                    )}
                </tbody>
            </table>
        </div>
    </main>

    {totalPages > 1 && (
        <nav class="mt-8 flex items-center justify-center gap-2">
            <a href={`?page=${page - 1}&q=${searchQuery}`} class={`px-4 py-2 rounded-xl text-xs font-bold ${page <= 1 ? 'bg-slate-100 text-slate-300 pointer-events-none' : 'bg-white shadow-sm text-indigo-600 hover:bg-indigo-50'}`}>&larr;</a>
            <span class="text-xs font-bold text-slate-400 mx-2">Hal {page} dari {totalPages}</span>
            <a href={`?page=${page + 1}&q=${searchQuery}`} class={`px-4 py-2 rounded-xl text-xs font-bold ${page >= totalPages ? 'bg-slate-100 text-slate-300 pointer-events-none' : 'bg-white shadow-sm text-indigo-600 hover:bg-indigo-50'}`}>&rarr;</a>
        </nav>
    )}
</div>

<div id="modalOverlay" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 backdrop-blur-sm p-4 overflow-y-auto">
    <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden animate-in zoom-in duration-200">
        <div class="bg-slate-900 p-6 text-white flex justify-between items-center">
            <h3 id="modalTitle" class="text-lg font-black uppercase">Entry Barang</h3>
            <button onclick="closeModal()" class="text-2xl hover:text-red-400 transition-colors">&times;</button>
        </div>
        <form method="POST" class="p-6 space-y-4">
            <input type="hidden" name="_action" id="formAction" value="create" />
            <input type="hidden" name="id" id="edit-id" />
            <div class="space-y-4">
                <input type="text" name="name" id="edit-name" required placeholder="Nama Barang" class="w-full border rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 outline-none" />
                <textarea name="description" id="edit-desc" rows="2" placeholder="Keterangan..." class="w-full border rounded-xl p-3 outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" name="total" id="edit-total" placeholder="Stok" class="border rounded-xl p-3 outline-none" />
                    <input type="text" name="unitType" id="edit-unit" placeholder="Satuan (pcs/dus)" class="border rounded-xl p-3 outline-none" />
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-red-50 p-3 rounded-xl">
                        <label class="text-[9px] font-black text-red-400 uppercase">Modal</label>
                        <input type="number" name="costPrice" id="edit-cost" class="w-full bg-transparent font-bold text-red-700 outline-none" />
                    </div>
                    <div class="bg-emerald-50 p-3 rounded-xl">
                        <label class="text-[9px] font-black text-emerald-500 uppercase">Jual</label>
                        <input type="number" name="sellingPrice" id="edit-selling" class="w-full bg-transparent font-bold text-emerald-700 outline-none" />
                    </div>
                </div>
            </div>
            <div class="flex gap-2 pt-4">
                <button type="button" onclick="closeModal()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-xs uppercase">Batal</button>
                <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-lg shadow-indigo-100">Simpan</button>
            </div>
        </form>
    </div>
</div>

<script is:inline>
    const modalOverlay = document.getElementById('modalOverlay');
    const formAction = document.getElementById('formAction');
    const modalTitle = document.getElementById('modalTitle');

    function openEntryModal() {
        formAction.value = 'create';
        modalTitle.innerText = 'Entry Barang Baru';
        ['edit-id', 'edit-name', 'edit-desc', 'edit-total', 'edit-unit', 'edit-cost', 'edit-selling'].forEach(id => {
            document.getElementById(id).value = '';
        });
        modalOverlay.classList.remove('hidden');
        modalOverlay.classList.add('flex');
    }

    function openEditModal(p) {
        formAction.value = 'update';
        modalTitle.innerText = 'Ubah Data Barang';
        document.getElementById('edit-id').value = p.id;
        document.getElementById('edit-name').value = p.name;
        document.getElementById('edit-desc').value = p.description || '';
        document.getElementById('edit-total').value = p.total;
        document.getElementById('edit-unit').value = p.unitType;
        document.getElementById('edit-cost').value = p.costPrice;
        document.getElementById('edit-selling').value = p.sellingPrice;
        modalOverlay.classList.remove('hidden');
        modalOverlay.classList.add('flex');
    }

    function closeModal() {
        modalOverlay.classList.add('hidden');
        modalOverlay.classList.remove('flex');
    }

    const searchInput = document.getElementById('realtimeSearch');
    let timeout = null;
    searchInput.addEventListener('input', (e) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            window.location.href = `/?q=${encodeURIComponent(e.target.value)}&page=1`;
        }, 500);
    });

    if (searchInput.value.length > 0) {
        searchInput.focus();
        searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
    }
</script>

</body>
</html>